<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Mystery Box - Kotak Kado Elegan</title>
<style>
  /* (Semua style seperti HTML asli kamu ‚Äî tidak diubah sama sekali) */
</style>
</head>
<body>
  <!-- Logo & Judul -->
  <div style="text-align: center; margin-bottom: 10px;">
    <img id="logo" src="https://i.ibb.co/rf3C7rYG/BLW-LOGO.png" alt="Logo" style="width: 300px; height: auto;">
    <h1 style="font-size: 24px; color: gold; margin: 0;">SELAMAT DATANG DI MYSTERY BOX - BELEGENDWIN</h1>
  </div>

  <!-- Floating Menu -->
  <div id="menuContainer">
    <button id="mainMenuBtn">‚ò∞</button>
    <div id="floatingMenu">
      <!-- Link menu -->
      <a href="https://belegendwin1.com" target="_blank">üîó Link Login Vip</a>
      <a href="https://klikblg.com/prediksitogel-blw" target="_blank">üéÆ Link Prediksi Togel</a>
      <a href="https://tinyurl.com/JADWALBOLABLW" target="_blank">üì¢ Link Jadwal Bola</a>
    </div>
  </div>

  <!-- FORM verifikasi -->
  <div class="form-container" id="inputSection">
    <div class="form-box">
      <input type="text" id="id" placeholder="Masukkan ID Anda" />
      <input type="text" id="kupon" placeholder="Masukkan Kode Kupon" />
      <button onclick="verifikasi()">Mulai Game</button>
    </div>
  </div>

  <!-- GAME BOX (tersembunyi awal) -->
  <div id="boxSection" style="display: none;">
    <div id="instructionBox" style="display:none;">KLIK UNTUK DIBUKA</div>
    <div class="box-container" id="boxContainer"></div>
  </div>

  <!-- Tombol & daftar hadiah -->
  <div id="tombol-hadiah-container">
    <button id="tombol-hadiah">üéÅ Tampilkan Hadiah</button>
  </div>
  <div id="daftar-hadiah">
    <!-- Daftar hadiah tetap seperti HTML asli -->
  </div>

  <!-- Canvas untuk efek bintang -->
  <canvas id="starCanvas"></canvas>

  <!-- Cara Bermain, result, menu gambar, LiveChat, popup, clickSound -->
  <!-- Semuanya tetap seperti di HTML asli kamu -->

  <audio id="clickSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <!-- CORS-friendly & fetch-based JS -->
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx_3SH9blPz4v-wKqtHdFm5CWXJAagYLOHwNNl6IrvNNlCAJXNoemapHuk47Jr0RSbrzQ/exec";
    let hadiahList = [1000,2000,3000,5000,8000,10000,100000,1000000,10000000];
    let rowIndex = null, sudahPilih = false, selectedBox = null;
    const clickSound = document.getElementById('clickSound');

    async function verifikasi() {
      const id = document.getElementById('id').value.trim().toUpperCase();
      const kupon = document.getElementById('kupon').value.trim().toUpperCase();
      if (!id||!kupon) return alert("Masukkan ID dan Kupon!");
      try {
        const res = await fetch(API_URL, {
          method:'POST',
          body: JSON.stringify({action:'checkCoupon',id,kupon}),
          headers:{'Content-Type':'application/json'}
        });
        const data = await res.json();
        if (data.status==='valid') {
          rowIndex = data.row;
          document.getElementById('inputSection').style.display='none';
          document.getElementById('boxSection').style.display='block';
          document.getElementById('instructionBox').style.display='block';
          mulaiBox();
        } else if (data.status==='used') {
          alert('Kupon sudah digunakan.');
        } else {
          alert('ID atau kupon tidak valid.');
        }
      } catch(err) {
        console.error(err);
        alert('Gagal memverifikasi kupon.');
      }
    }

    function mulaiBox() {
      shuffle(hadiahList);
      const container = document.getElementById('boxContainer');
      container.innerHTML = '';
      sudahPilih=false; selectedBox=null;
      hadiahList.forEach((h,i)=>{
        const div = document.createElement('div');
        div.className='box';
        div.dataset.hadiah=h;
        div.onclick = () => {
          if (sudahPilih) return;
          sudahPilih=true; selectedBox=div;
          clickSound.play(); bukaKotak(div);
        };
        container.appendChild(div);
      });
    }

    function bukaKotak(box) {
      const pilihan = hadiahList.filter(h=>h<10000);
      const hadiahTerpilih = pilihan[Math.floor(Math.random()*pilihan.length)];
      box.classList.add('selected');
      box.textContent = `Rp ${hadiahTerpilih.toLocaleString()}`;
      box.style.borderColor = '#ffd700';
      buatPopup(hadiahTerpilih);
      fetch(API_URL, {
        method:'POST',
        body: JSON.stringify({action:'simpanHasil',row:rowIndex,hadiah:hadiahTerpilih}),
        headers:{'Content-Type':'application/json'}
      });
    }

    function buatPopup(h) {
      const popup = document.getElementById('popupOverlay');
      const tbody = document.querySelector('#hadiahTable tbody');
      tbody.innerHTML='';
      hadiahList.forEach((val,i)=>{
        const tr=document.createElement('tr');
        const tdNo=document.createElement('td'); tdNo.textContent = i+1;
        const tdHad=document.createElement('td'); tdHad.textContent = `Rp ${val.toLocaleString()}`;
        if(val===h) tdHad.classList.add('selected-cell');
        tr.append(tdNo,tdHad); tbody.appendChild(tr);
      });
      popup.style.display='flex';
      document.getElementById('closePopup').onclick = () => {
        popup.style.display='none';
        bukaHadiahLain(h);
      };
    }

    function bukaHadiahLain(h) {
      document.querySelectorAll('.box').forEach(b=>{
        if(!b.classList.contains('selected')) {
          b.classList.add('opened');
          b.textContent = `Rp ${parseInt(b.dataset.hadiah).toLocaleString()}`;
          b.style.borderColor = 'rgba(255,215,0,0.5)';
        }
      });
    }

    function shuffle(arr) {
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    document.getElementById('tombol-hadiah').addEventListener('click', ()=>{
      const d = document.getElementById('daftar-hadiah');
      d.style.display = d.style.display==='flex'?'none':'flex';
    });
    document.getElementById('mainMenuBtn').addEventListener('click', ()=>{
      const m = document.getElementById('floatingMenu');
      m.style.display = m.style.display==='flex'?'none':'flex';
    });

    /* Inisialisasi efek bintang */
    (function(){
      const canvas = document.getElementById('starCanvas');
      const ctx = canvas.getContext('2d');
      let width,height;
      function resize(){ width=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight; }
      window.addEventListener('resize',resize); resize();
      const groups=[]; for(let g=0;g<20;g++){
        const stars=[]; for(let s=0;s<random(10,20);s++){ stars.push({x:random(0,width),y:random(0,height),dx:random(-0.3,0.3),dy:random(-0.3,0.3),size:random(3,6)}); }
        groups.push(stars);
      }
      function draw(){
        ctx.clearRect(0,0,width,height);
        groups.forEach(stars=>{
          stars.forEach(s=>{
            s.x+=s.dx; s.y+=s.dy;
            if(s.x<0||s.x>width) s.dx*=-1;
            if(s.y<0||s.y>height) s.dy*=-1;
            ctx.fillStyle='rgba(255,45,33,0.9)'; createStar(s.x,s.y,s.size);
          });
          for(let i=0;i<stars.length;i++){
            for(let j=i+1;j<stars.length;j++){
              if(Math.hypot(stars[i].x-stars[j].x,stars[i].y-stars[j].y)<100){
                ctx.strokeStyle='rgba(107,107,127,0.4)'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(stars[i].x,stars[i].y); ctx.lineTo(stars[j].x,stars[j].y); ctx.stroke();
              }
            }
          }
        });
        requestAnimationFrame(draw);
      }
      function createStar(x,y,r){ ctx.beginPath(); const p=5,step=Math.PI/p;
        for(let i=0;i<2*p;i++){ const rad = i%2===0?r:r/2; ctx.lineTo(x+rad*Math.cos(i*step), y+rad*Math.sin(i*step)); }
        ctx.closePath(); ctx.fill();
      }
      function random(a,b){return Math.random()*(b-a)+a;}
      draw();
    })();
  </script>

  <!-- Footer -->
  <div class="footer" style="text-align: center; padding: 20px 0; font-size: 14px; color: #ccc;">
    ¬© <span id="year"></span> BELEGENDWIN. Semua hak dilindungi.
  </div>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
